name: Workflow lint and security checks

on:
  pull_request:
    paths:
      - .github/workflows/**

permissions:
  contents: read

jobs:
  actionlint:
    name: Lint GitHub Actions workflows
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Run actionlint
        uses: rhysd/actionlint@393031adb9afb225ee52ae2ccd7a5af5525e03e8 # v1.7.11
        with:
          fail_on_error: true

  workflow-security:
    name: Check workflow security guardrails
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install Python dependency for security checks
        run: python -m pip install --disable-pip-version-check pyyaml

      - name: Run workflow security checks
        run: |
          python - <<'PY'
          from pathlib import Path
          import re
          import sys

          import yaml

          workflow_dir = Path('.github/workflows')
          workflow_files = sorted(
              p for p in workflow_dir.glob('*.y*ml') if p.is_file()
          )

          if not workflow_files:
              print('No workflow files found in .github/workflows. Nothing to check.')
              sys.exit(0)

          sha_pattern = re.compile(r'^[0-9a-fA-F]{40}$')
          violations = []

          def extract_uses(node):
              matches = []
              if isinstance(node, dict):
                  for key, value in node.items():
                      if key == 'uses' and isinstance(value, str):
                          matches.append(value.strip())
                      else:
                          matches.extend(extract_uses(value))
              elif isinstance(node, list):
                  for item in node:
                      matches.extend(extract_uses(item))
              return matches

          for workflow_path in workflow_files:
              data = yaml.safe_load(workflow_path.read_text()) or {}
              if not isinstance(data, dict):
                  continue

              top_permissions = data.get('permissions')
              if top_permissions is None:
                  violations.append(
                      f"{workflow_path}: missing top-level 'permissions'. "
                      "Define least-privilege permissions (for example, contents: read)."
                  )
              elif isinstance(top_permissions, str) and top_permissions == 'write-all':
                  violations.append(
                      f"{workflow_path}: top-level permissions are 'write-all'. "
                      "Use minimal scoped permissions instead."
                  )

              jobs = data.get('jobs', {})
              if isinstance(jobs, dict):
                  for job_name, job in jobs.items():
                      if not isinstance(job, dict):
                          continue
                      job_permissions = job.get('permissions')
                      if isinstance(job_permissions, str) and job_permissions == 'write-all':
                          violations.append(
                              f"{workflow_path} [job: {job_name}]: permissions are 'write-all'. "
                              "Reduce to only required scopes."
                          )

              for uses_value in extract_uses(data):
                  if uses_value.startswith('./') or uses_value.startswith('docker://'):
                      continue
                  if '@' not in uses_value:
                      violations.append(
                          f"{workflow_path}: action reference '{uses_value}' is missing a version pin."
                      )
                      continue

                  source, ref = uses_value.split('@', 1)
                  source_parts = source.split('/')
                  if len(source_parts) < 2:
                      continue

                  owner = source_parts[0].lower()
                  if owner in {'actions', 'github'}:
                      continue

                  if not sha_pattern.fullmatch(ref):
                      violations.append(
                          f"{workflow_path}: third-party action '{uses_value}' is not pinned to a full commit SHA. "
                          "Pin external actions to a 40-character commit SHA."
                      )

          if violations:
              print('Workflow security checks failed. Please address the following issues:')
              for issue in violations:
                  print(f'- {issue}')
              print('\nTips:')
              print('- Pin third-party actions with full SHAs: owner/repo/path@<40-char-sha>')
              print("- Set explicit minimal 'permissions' at workflow or job level.")
              sys.exit(1)

          print('Workflow security checks passed: permissions and action pins look good.')
          PY
